function WikiLoader(){var b="/global/php/wiki_reader.php";WikiLoader.prototype.getWikiContent=function(i){var g=$(i).attr("class");if(typeof(g)=="undefined"){return}if(g.indexOf("tzr-intro-1")>-1){g="tzr-intro-1";$(i).append('<p class="wtarg">Loading .... </p>')}else{if(g.indexOf("tzr-box1")>-1){g="tzr-box1";$(i).append('<p class="wtarg">Loading .... </p>')}else{if(g.indexOf("tzr-1")>-1){g="tzr-1";$(i).append('<div class="wtarg">Loading .... </div>')}else{if(i.tagName.toLowerCase()=="p"){g="p";$(i).addClass("wtarg");$(i).prepend("Loading ...")}else{if(g=="full"){$(i).append('<p class="wtarg">Loading .... </p>')}else{return}}}}}var h=$(i).find("a.wiki:first");$(h).hide();var j=$(h).attr("href");if(typeof(j)=="undefined"||j.indexOf("/.html")>-1){$(i).html("<h4><a>No Wiki Page Set</a></h4><p><b>No wiki page set for this box!</b></p>");return}$(i).append('<div class="wikicontent" style="visibility: hidden; display: none;"></div>');var k=$(i).children("div.wikicontent:first");$.ajax({url:b,data:"url="+j+"&type=box",success:function(l){$(k).html(l);f(i,g)}})};function f(j,i){var g=$(j).children("div.wikicontent:first");var l=$(g).find("#wout");if(typeof(l)=="undefined"||l.length==0){console.log("No wiki content found in processWikiContent (class_wikiloader.js, l. 67):");console.trace();return}l=$(l[0]).html();l="<div>"+l.replace(/&lt;/g,"<").replace(/&gt;/g,">")+"</div>";g=$(l);var o=$(j).find(".wtarg");var p=$(j).find("a.wiki:first");var y=$(p).attr("href");var m=$(p).attr("class").replace("wiki","");var q=new Specs(m);var r=q.getSpec("c");var n="";var z=(q.opt("new window"))?' target="_blank"':"";$(p).remove();if(i=="tzr-intro-1"){if(!r){if($(j).attr("class").indexOf("stacked")>-1){r=225}else{r=400}}$(o).html(c(g,r,y));if(!q.opt("read more")){loc=d(g,y);alnk='<a href="'+loc+'" class="read-more"'+z+">";if(loc=="#wiki="+y||loc.indexOf("/wiki/")>-1){n="Read More"}else{n=e(g)}$(o).find("p:last").append("... "+alnk+n+"</a>")}if($.browser.msie&&$.browser.version=="8.0"){myhtml=$(o).find("p").html();myhtml=myhtml.replace("<p>","").replace("</p>","");$(o).html(myhtml)}if(!q.opt("drop cap")){a($(o))}$(o).replaceWith($(o).html())}else{if(i=="tzr-box1"){$(g).find("a.anchorpoint").remove();h4txt=$(g).find("h3.heading-h1:first").html();h5="";if($(g).find("h3.heading-h2:first").length>0&&!q.opt("no head")){h5="<h5>"+$(g).find("h3.heading-h2:first").html()+"</h5>"}h6="";if($(g).find("h3.heading-h3:first").length>0&&!q.opt("no head")){h6="<h6>"+$(g).find("h3.heading-h3:first").html()+"</h6>"}if(h5==""&&h6==""){$(j).children("p:first").css("padding-top","6pt")}if(!r){r="300"}var t=c(g,r,y);$(o).html(t);loc=d(g,y);alnk='<a href="'+loc+'"'+z+">";if($(j).children("h4:first").length==0){$(j).prepend("<h4></h4>")}$(j).children("h4:first").html('<a href="'+loc+'"'+z+">"+h4txt+"</a>");var w=$(g).find("a").filter(function(){return $.trim($(this).text())=="image"});if(w.length>0){w=w.eq(w.length-1);var x=$(w).attr("href");var v="";if($(g).find("div.caption").length>0){v=$(g).find("div.caption p").text();$(g).find("div.caption").remove()}$(j).children("h4:first").after(alnk+'<img src="'+x+'" title="'+v+'" /></a>')}$(j).children("img:first").wrap(alnk+"</a>");if(!q.opt("read more")){if(loc=="#wiki="+y){n="Read More"}else{n=e(g)}var s=$(o).find(">*:last");if(typeof(s)=="object"&&s.text&&s.text()!=""){$(s).html($(s).html().replace("\u2026","..."));if($(s).text().indexOf("\u2026")==-1&&$(s).text().indexOf("...")==-1){$(s).append("...")}$(s).append(' <a href="'+loc+'" class="read-more"'+z+">"+n+"</a>")}}if(q.opt("drop cap")){a($(o))}$(o).replaceWith($(o).html())}else{if(i=="tzr-1"){h4txt=$(g).find("h3.heading-h1:first").html();h5="";if($(g).find("h3.heading-h2:first").length>0&&!q.opt("no head")){h5="<h5>"+$(g).find("h3.heading-h2:first").html()+"</h5>"}else{$(j).children("p:first").css("padding-top","6pt")}h6="";if($(g).find("h3.heading-h3:first").length>0&&!q.opt("no head")){h6="<h6>"+$(g).find("h3.heading-h3:first").html()+"</h6>"}if(!r){r="300"}$(o).html(c(g,r,y));loc=d(g,y);alnk='<a href="'+loc+'"'+z+">";if($(j).children("h4:first").length==0){$(j).prepend("<h4></h4>")}else{h4=$(j).children("h4:first").html()}h4txt=h4txt.replace(/<a[^\/]+<\/a>/,"");$(j).children("h4:first").html('<a href="'+loc+'"'+z+">"+h4txt+"</a>");var w=$(g).find("a").filter(function(){return $.trim($(this).text())=="image"});if(w.length>0){w=w.eq(w.length-1);var x=$(w).attr("href");var v="";if($(g).find("div.caption").length>0){v=$(g).find("div.caption p").text();$(g).find("div.caption").remove()}$(j).children("h4:first").after(alnk+'<img src="'+x+'" title="'+v+'" /></a>')}$(j).children("img:first").wrap(alnk+"</a>");if(!q.opt("read more")){var s=$(o).children("*:last");if(typeof(s)=="object"&&s.text&&s.text()!=""){$(s).append("... ");var k=$(s).html();if(k!=null&&typeof(k)=="string"){$(s).html(k.replace(". ...","..."))}}if(loc=="#wiki="+y){n="Read More"}else{n=e(g)}if($(o).children("*:last").text()!=""){$(o).children("*:last").append('  <a href="'+loc+'" class="read-more"'+z+">"+n+"</a>")}}if(q.opt("drop cap")){a($(o))}}else{if(i=="p"){if(!r){r=400}$(j).html(c(g,r,y));var h="";var u="";$(j).find("table").each(function(){u+=$(this).toXML()});$(j).find("p").each(function(){var A="";if($(this).next("p").length>0){A="<br/><br/>"}h+=$(this).html()+A});$(j).html(h);$(j).after(u);if(!q.opt("read more")&&r!="all"){loc=d(g,y);alnk='<a href="'+loc+'" class="read-more"'+z+">";if(loc=="#wiki="+y||loc.indexOf("/wiki/")>-1){n="Read More";if(u==""){$(j).append("... ")}}else{n=e(g)}if(u==""){$(j).append("  "+alnk+n+"</a>")}else{$(j).siblings("table").after("<p>"+alnk+n+"</a></p>")}}if(q.opt("drop cap")){a(j)}}else{if(i=="full"){$(j).html($(g).html());$("ul.star").removeClass("star").addClass("bullet-blue");$(".heading-h6, .heading-h1").remove();$(j).removeClass("full").addClass("wiki")}}}}}$(o).removeClass("wtarg");if(i!="p"||i!="full"){$(g).remove()}$("img[title^=external]").remove();$("img[alt^=external]").remove();$("img[src*=icklearrow]").remove();$('img[src=""]').remove();$("span.nobr").each(function(){var A=$(this).html();$(this).before(A);$(this).remove()});$("*[target='rwikiexternal']").each(function(){var A=$(this).attr("href");$(this).removeAttr("target");if(typeof(A)=="string"&&(A.substr(0,1)=="/"||(A.indexOf("www.thdl")==-1&&A.indexOf("old.thdl")==-1&&A.indexOf("thdl.org")>-1)||A.indexOf("thlib")>-1)){$(this).attr("rel","")}else{$(this).attr("rel","external")}});ConvertExternalLinks();$(".wiki-table *").css("vertical-align","top").css("padding","2px");$("a[href*='%26']").each(function(A){this.href=this.href.replace("%26","|amp|")});EmbedQT(j);ActivateLinks(j);$("a:contains('image')").each(function(){if($(this).text()=="image"){$(this).hide()}})}function d(h,k){var j;if($(h).find("div.resource-link a:first").length>0){j=$(h).find("div.resource-link a:first").attr("href")}if(typeof(j)=="string"&&j.length>0){j=j.replace("http://WIKI","#wiki=").replace("http://wiki","#wiki=");j=j.replace("http://ESSAYPG","#essaypg=").replace("http://essaypg","#essaypg=");j=j.replace("http://ESSAY","#essay=").replace("http://essay","#!essay=");j=j.replace("http://DOMAIN/","/").replace("http://domain/","/")}else{j="#wiki="+k;if(j.indexOf("#wiki=/access/wiki/site/0b308aa3-d044-469b-009a-d34c7841413d/")>-1){var g=window.location.pathname;if(g.indexOf(".php")>-1){var i=g.split(/\//);i.pop();var g=i.join("/")}j=g+j.replace("#wiki=/access/wiki/site/0b308aa3-d044-469b-009a-d34c7841413d/","/about/wiki/");j=j.replace("//","/")}}return j}function e(h){var g="Explore!";if($(h).find("div.resource-link a:first").length>0){var k=$(h).find("div.resource-link a:first");var i=$(k).text();var j=$(k).attr("href");if(j.indexOf("essay")>-1||j.indexOf("ESSAY")>-1||j.indexOf("wiki")>-1){g="Read More"}if(typeof(i)=="string"&&i!=j&&j.indexOf(i)==-1&&i.indexOf("/")==-1){g=Trim(i)}}return g}function c(w,y,D){$(w).find(".heading-h2").each(function(){var n=$(this).html();$(this).replaceWith('<h5 class="whead">'+n+"</h5>")});var g=0;var p="";var q=false;var r="";var o=0;try{if(y=="all"){if($(w).find(".whead:eq(0)").html()!=null){p='<h5 class="whead">'+$(w).find(".whead:eq(0)").html()+"</h5>"}$(w).find("p, ul, blockquote, table, tr, td").each(function(){if(!$(this).parent().hasClass("resource-link")&&$(this).find("img").length==0&&!$(this).parent().hasClass("caption")){if($.browser.msie){sttag='<p class="paragraph">';entag="</p>";if($(this).is("ul")){sttag='<ul class="bullet-blue">';entag="</ul>"}else{if($(this).is("ol")){sttag="<ol>";entag="</ol>"}else{if($(this).is("blockquote")){sttag="<blockquote>";entag="</blockquote>"}else{if($(this).is("div")){sttag="<div>";entag="</div>"}else{if($(this).is("table")){sttag="<table>";entag="</table>"}else{if($(this).is("tr")){sttag="<tr>";entag="</tr>"}else{if($(this).is("td")){sttag="<td>";entag="</td>"}}}}}}}p+=sttag+$(this).html()+entag}else{p+=$(this).toXML()}}});p=p.replace(/class="star"/,'class="bullet-blue"');return p}else{var z=function(){if($(this).attr("class")=="paragraph"||$(this).attr("class")=="whead"){var n=$(this).text();if(typeof(n)=="string"&&((n.length==1&&n.charCodeAt(0)==10)||n.length==0)){return false}else{if(typeof(n)=="undefined"){return false}else{return true}}}else{return false}};var C=$(w).children().filter(z);for(var k=0;k<C.length;k++){g+=$(C[k]).text().length;if(g>y){o=g-y;var l=$(C[k]).html();var u=l.length-o;var t=l.substr(u).indexOf(" ");l=l.substr(0,u+t);var j=$(C[k]);$(j).html(l);if($.browser.msie&&$(j).is("p")){p+='<p class="paragraph">'+$(j).html()+"</p>"}else{p+=" "+$(j).toXML()}return p}if($.browser.msie&&$(C[k]).is("p")){p+='<p class="paragraph">'+$(C[k]).html()+"</p>"}else{p+=" "+$(C[k]).toXML()}}var h="";var B=0;var i=false;for(var v=0;v<y;v++){var x=p.substr(v,1);if(!i&&x=="<"){i=true;if(p.substr(v+1,1)=="/"){q=false}else{q=true}}else{if(i&&x==">"){i=false}else{if(i==false){B+=1;if(B>=y&&q==false){if(i){h+=p.substr(v,p.substr(v).indexOf(">"))}else{h+=p.substr(v,p.substr(v).indexOf(" "))}break}}}}h+=x}p=h}}catch(A){p="Problem loading content! ("+typeof(p)+":"+p+") : "+A.toString()+"("+A.stack+') : Possibly incorrect <a href="https://collab.itc.virginia.edu'+D+'" target="_blank">wiki url</a>!<br/>'}var s=p.lastIndexOf("<");var m=p.lastIndexOf(">");if(m<s){p=p.substring(0,m)}return p}function a(i){var g=Trim($(i).html());var h=g.substr(0,1);while(h=="<"){i=$(i).children()[0];g=Trim($(i).html());h=g.substr(0,1)}if(h==""){return}g='<span class="dropcap">'+h+"</span>"+g.substr(1);$(i).html(g)}}function Specs(a){this.spcs=a;this.sarr=a.split(" ")}Specs.prototype.getSpec=function(a){for(var b in this.sarr){if(this.sarr[b].indexOf(a)>-1){return this.sarr[b].replace(a,"")}}return false};Specs.prototype.isSpec=function(a){for(var b in this.sarr){if(this.sarr[b].indexOf(a)>-1){return true}}return false};Specs.prototype.opt=function(a){if(this.getSpec("o")){switch(a.toLowerCase().replace(" ","-")){case"read-more":if(this.getSpec("o").toLowerCase().indexOf("1")>-1){return true}break;case"drop-cap":if(this.getSpec("o").toLowerCase().indexOf("2")>-1){return true}break;case"no-head":if(this.getSpec("o").toLowerCase().indexOf("3")>-1){return true}break;case"new-window":if(this.getSpec("o").toLowerCase().indexOf("4")>-1){return true}break;default:break}}return false};var wikiLoader;